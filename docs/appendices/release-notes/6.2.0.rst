.. _version_6.2.0:

==========================
Version 6.2.0 - Unreleased
==========================


.. comment 1. Remove the " - Unreleased" from the header above and adjust the ==
.. comment 2. Remove the NOTE below and replace with: "Released on 20XX-XX-XX."
.. comment    (without a NOTE entry, simply starting from col 1 of the line)
.. NOTE::

    In development. 6.2.0 isn't released yet. These are the release notes for
    the upcoming release.

.. NOTE::

    If you are upgrading a cluster, you must be running CrateDB 5.0.0 or higher
    before you upgrade to 6.2.0.

    We recommend that you upgrade to the latest 6.1 release before moving to
    6.2.0.

    A rolling upgrade from >= 6.1.0 to 6.2.0 is supported.
    Before upgrading, you should `back up your data`_.

.. WARNING::

    Tables that were created before CrateDB 5.x will not function with 6.x
    and must be recreated before moving to 6.x.x.

    You can recreate tables using ``COPY TO`` and ``COPY FROM`` or by
    `inserting the data into a new table`_.

.. _back up your data: https://cratedb.com/docs/crate/reference/en/latest/admin/snapshots.html
.. _inserting the data into a new table: https://cratedb.com/docs/crate/reference/en/latest/admin/system-information.html#tables-need-to-be-recreated

.. rubric:: Table of contents

.. contents::
   :local:

.. _version_6.2.0_breaking_changes:

Breaking Changes
================

- Changed the detailed :ref:`http error code <http-error-codes>` for the
  ``Duplicate Object`` error from ``4100`` to ``40910`` as it is a conflict.

- Changed the detailed :ref:`http error code <http-error-codes>` for the
  ``Query killed`` error from ``5030`` to ``5005`` as it is an internal server
  error.

Deprecations
============

None


Changes
=======

SQL Statements
--------------

None

SQL Standard and PostgreSQL Compatibility
-----------------------------------------

- Added a ``client_encoding`` session setting. The only supported value is
  ``UTF8``. Other values are not supported and will continue to result in INFO
  log message that the SET SESSION statement is ignored.

- Columns names prefixed with an underscore are now accepted, although their use
  is still discouraged to avoid conflicts in case future CrateDB versions
  introduce additional system columns.

  As a side effect of this change, using the existing system columns in write
  operations now causes an error instead of silently discarding the values.

  For example, in earlier versions the behavior was as follows::

      cr> create table tbl (x int);
      cr> insert into tbl (x, _id, _version, _seq_no) values (1, 100, 200, 300);
      cr> refresh table tbl;
      cr> select *, _id, _version, _seq_no from tbl;
      +---+----------------------+----------+---------+
      | x | _id                  | _version | _seq_no |
      +---+----------------------+----------+---------+
      | 1 | Szu9JZoBFWbuMAwIJry8 |        1 |       0 |
      +---+----------------------+----------+---------+

  In 6.2.0 the ``INSERT INTO`` statement results in an error::

      cr> insert into tbl (x, _id, _version, _seq_no) values (1, 100, 200, 300);
      InvalidColumnNameException["_id" Cannot write to system column]

- Added support for selecting more than one column within a subquery used in a
  ``EXISTS`` clause.

Data Types
----------

- Added support for the :ref:`UUID type <type-uuid>`.


Scalar and Aggregation Functions
--------------------------------

None

Performance and Resilience Improvements
---------------------------------------

- Added an optimization rule to push down query predicates in cases where the
  child relation is using scalar sub-queries.

  For example, given the following setup::

    CREATE TABLE t1 (x int, y int);
    CREATE TABLE t2 (a int, b int);
    CREATE VIEW v1 AS SELECT * FROM t1 where x in (select a from t2)

  A query on the view is now pushed down to ``t1`` to utilize its indices::

    SELECT * from v1 where y = 10

- Reduced the memory footprint of the internal state used in the
  :ref:`hyperloglog_distinct <aggregation-hyperloglog-distinct>` aggregation.
  This should help if using the aggregation together with a GROUP BY with many
  unique keys.

- Changed the :ref:`swapping <alter_cluster_swap_table>` and
  :ref:`renaming <sql-alter-table-rename-to>` of tables to no longer re-allocate
  the shards of the swapped/renamed table, so that in-progress snapshots can
  finish successfully. Previously, the in-progress snapshots would fail and
  remain in ``PARTIAL`` state, with an ``ABORTED`` failure message showing in
  the :ref:`sys.snapshots <sys-snapshots>` system table.

Administration and Operations
-----------------------------

- Enabled TCP fallback for SRV DNS queries used when
  :ref:`Node Discovery via DNS <conf_dns_discovery>` is enabled.

Client interfaces
-----------------

- Added more detailed errors and their corresponding
  :ref:`http error codes <http-error-codes>` for some of which were previously
  mapped to generic error.
